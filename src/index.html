<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Manager</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body class="darkmode">
    <article>
    <h1>All persons</h1>
    <p id="getallresponse"></p>
    <script>
        function getallpersons(){
            res="<table><tr>"
            res+="<th>lp.</th>"
            res+="<th>Imie</th>"
            res+="<th>Nazwisko</th>"
            res+="<th>Stanowisko</th>"
            res+="<th>Pesel</th>"
            res+="<th>Data Urodzenia</th>"
            res+="<th>Data Zatrudnienia</th>"
            res+="<th>Usuń</th>"


            res+="</tr>"
            fetch("http://127.0.0.1:5000/persons")
                .then(response=>response.json())
                .then(response=>{
                console.log(response)
                let i=0
                    for (const person of response){
                        res+="<tr>"
                            res+="<th>"+(++i)+"</th>"
                            res+="<td>"+person["imie"]+"</td>"
                            res+="<td>"+person["nazwisko"]+"</td>"
                            res+="<td>"+person["stanowisko"]+"</td>"
                            res+="<td>"+person["pesel"]+"</td>"
                            res+="<td>"+person["data_urodzenia"].substring(0, 10)+"</td>"
                            res+="<td>"+person["data_zatrudnienia"].substring(0, 10)+"</td>"
                            /*for(const key in person){
                                if (person.hasOwnProperty(key)) {
                                res+="<td>"+person[key]+"</td>"
                                }
                            }*/
                            res+="<td><button onclick='deleteperson("+person.pesel+")'>X</button></td>"
                        res+="</tr>"
                    }
                    
                    res+="</table>" 
                getallresponse.innerHTML = res
        })
    }
    getallpersons()
    function deleteperson(pesel){
            if(confirm("remove person with pesel "+pesel+"?")){

            a="http://127.0.0.1:5000/person?pesel="+pesel
            console.log(a)
                fetch(a, {method:'DELETE'})
                //.then(response=>response.json())
                .then(() => getallpersons())
            }
    }
    //setInterval(getallpersons(), 1000)
    </script>
    </article>
    <nav>
        <button onclick="show('#addperson')">dodaj</button>
        <button onclick="show('#deleteperson')">usuń</button>
        <button onclick="show('#updateperson')">edytuj</button>
        <button onclick="show('#getperson')">wyswietl 1</button>
        <button id="color">change color theme</button>
        <script>
           function show(name) {
                const divs = document.querySelectorAll("div");
                divs.forEach(div => {
                div.style.display = "none"; // poprawna wartość: "none", nie "None"
            });
            document.querySelector(name).style.display = "block";
            }
            color.onclick=()=>{
                if(document.body.getAttribute("class")=="darkmode"){
                    document.body.setAttribute("class", "") 
                }
                else{
                    document.body.setAttribute("class", "darkmode") 
                }
                           
            }
        </script>
    </nav>
    <div id="addperson">
    <h1>Add a person</h1>
    <form>
        <label>
            Imie:<input type="text" id="imie" required>
        </label>
        <label>
            Nazwisko: <input type="text" id="nazwisko" required>
        </label>
        <label>
            Pesel: <input type="number" id = "pesel" min="10000000000" max="99999999999" required>
        </label>
        <label>
            Stanowisko: <input type="text" id="stanowisko" required>
        </label>
        <label>
            Data Urodzenia: <input type="date" id="data_urodzenia" required>
        </label>
        <label>
            Data Zatrudnienia: <input type="date" id="data_zatrudnienia" required>
        </label>
        <input type="button" value="dodaj" id="add">
    </form>
    <p id="addresponse"></p>
    <script>
        add.onclick=()=>{
        fetch('http://127.0.0.1:5000/person', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    imie: imie.value,
    nazwisko: nazwisko.value,
    pesel: pesel.value,
    stanowisko: stanowisko.value,
    data_urodzenia: data_urodzenia.value,
    data_zatrudnienia: data_zatrudnienia.value
  })
})
.then(response => response.json())
.then(data => {
  addresponse.innerHTML = 'Person added:'+data
})
.then(() => getallpersons())
.catch(error => {
  console.error('Error:', error);
});

        }

    </script>
    </div>
    <div id="getperson">
    <h1>Get a person</h1>
    <form>
        <label>
            Pesel <input type="text" id="getpesel" required>
        </label>
        <input type="button" value="wyszukaj" id="get1">

    </form>
    <p id="get1response"></p>
    <script>
        get1.onclick=()=>{
            
            a="http://127.0.0.1:5000/person?pesel="+getpesel.value
            console.log(a)
                fetch(a)
                .then(response=>response.json())
                .then(response=>{
                    res="<table>"
                console.log(response)
                   if (response!=null){
                        res+="<tr>"
                            for(const key in response){
                                if (response.hasOwnProperty(key)) {
                                res+="<td>"+response[key]+"</td>"
                                }
                            }
                        res+="</tr>"
                    
                    res+="</table>" 
                get1response.innerHTML = res}
                else{
                    get1response.innerHTML = "person not found"
                }

                })
        }
    </script>
    </div>
    <div id="deleteperson">
    <h1>Delete a person</h1>
    <form>
        <label>
            Pesel <input type="text" id="delpesel" required>
        </label>
        <input type="button" value="usuń" id="del">

    </form>
    <p id="delresponse"></p>
    <script>
     del.onclick=()=>{
            a="http://127.0.0.1:5000/person?pesel="+delpesel.value
            console.log(a)
                fetch(a, {method:'DELETE'})
                //.then(response=>response.json())
                
                .then(response => response.json())
                .then(data => {
  delresponse.innerHTML = 'Person deleted:'+data
})
.then(() => getallpersons())
     }
        </script>
    </div>
    <div id="updateperson">
        <h1>Update a person</h1>
    <form>
        <label>
            Imie:<input type="text" id="imieupd">
        </label>
        <label>
            Nazwisko: <input type="text" id="nazwiskoupd">
        </label>
        <label>
            Pesel: <input type="number" id = "peselupd" min="10000000000" max="99999999999" required>
        </label>
        <label>
            Stanowisko: <input type="text" id="stanowiskoupd">
        </label>
        <label>
            Data Urodzenia: <input type="date" id="data_urodzeniaupd">
        </label>
        <label>
            Data Zatrudnienia: <input type="date" id="data_zatrudnieniaupd">
        </label>
        <input type="button" value="aktualizuj" id="upd">
    </form>
    <p id="updresponse"></p>
    <script>
        upd.onclick=()=>{
        const imie = document.getElementById('imieupd');
        const nazwisko = document.getElementById('nazwiskoupd');
        const pesel = document.getElementById('peselupd');
        const stanowisko = document.getElementById('stanowiskoupd');
        const dataUrodzenia = document.getElementById('data_urodzeniaupd');
        const dataZatrudnienia = document.getElementById('data_zatrudnieniaupd');
    let url = 'http://127.0.0.1:5000/person'
    if (pesel.value.trim() !== ''){
       url+=('?pesel='+ pesel.value.trim());
        if (imie.value.trim() !== '') url+=('&imie='+ imie.value.trim());
        if (nazwisko.value.trim() !== '') url+=('&nazwisko='+ nazwisko.value.trim());
        
        if (stanowisko.value.trim() !== '') url+=('&stanowisko='+ stanowisko.value.trim());
        if (dataUrodzenia.value !== '') url+=('&data_urodzenia='+ dataUrodzenia.value);
        if (dataZatrudnienia.value !== '') url+=('&data_zatrudnienia='+ dataZatrudnienia.value);
    } 
            console.log(url);  
            fetch(url, {method:'PATCH'})
                //.then(response=>response.json())
                
                .then(response => response.json())
                .then(data => {
  updresponse.innerHTML = 'Person updated:'+data
})
.then(() => getallpersons())
     }
     show("#addperson")
    </script>
    </div>
</body>
</html>