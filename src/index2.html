<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>v2 Person Manager</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <article>
    <h1>All persons</h1>
    <p id="getallresponse"></p>
    <script>
         function getpersonid(pesel){
        return fetch("http://127.0.0.1:8000/person/pesel/"+pesel)
                .then(response=>response.json())
                .then(response=>{
                return response["id"]})
     }
     jobs={}
        fetch("http://127.0.0.1:8000/jobs/")
                .then(response=>response.json())
                .then(response=>{
                    jobdict={}
                    response.forEach(e => {
                        jobdict[e["id"]]=e["nazwa"]
                    });
                    console.log(jobdict)
                    jobs = jobdict
                    
        stanowisko.innerHTML = "";
        console.log(jobs)
        for (const id in jobs) {
            const name = jobs[id];
            stanowisko.innerHTML += `<option value="${id}">${name}</option>`;
            stanowiskoupd.innerHTML = stanowisko.innerHTML
        }
                    
            })
    function getjob(id){
        return jobs[id]
    }



        function update(p = "") {
    let peselValue;
    let updatedData = {};

    if (p === "") {
        // Edycja z formularza górnego (np. osobna sekcja aktualizacji)
        const imie = document.getElementById('imieupd');
        const nazwisko = document.getElementById('nazwiskoupd');
        const pesel = document.getElementById('peselupd');
        const stanowisko = document.getElementById('stanowiskoupd');
        const dataUrodzenia = document.getElementById('data_urodzeniaupd');
        const dataZatrudnienia = document.getElementById('data_zatrudnieniaupd');

        peselValue = pesel.value.trim();
        if (peselValue === "") {
            alert("PESEL jest wymagany.");
            return;
        }

 updatedData = {};
if(imie.value.trim() !== '') updatedData.imie = imie.value.trim();
if(nazwisko.value.trim() !== '') updatedData.nazwisko = nazwisko.value.trim();
if(stanowisko.value.trim() !== '') updatedData.stanowisko = stanowisko.value.trim();
if(dataUrodzenia.value !== '') updatedData.data_urodzenia = dataUrodzenia.value;
if(dataZatrudnienia.value !== '') updatedData.data_zatrudnienia = dataZatrudnienia.value;

    } else {
        // Edycja z tabeli (kliknięcie na / przy osobie)
        const imie = document.getElementById('uname');
        const nazwisko = document.getElementById('usurname');
        const stanowisko = document.getElementById('ujob');
        const dataUrodzenia = document.getElementById('udob');
        const dataZatrudnienia = document.getElementById('uhired');

        peselValue = p.toString();

        updatedData = {
            imie: imie.value.trim(),
            nazwisko: nazwisko.value.trim(),
            stanowisko: stanowisko.value.trim(),
            data_urodzenia: dataUrodzenia.value,
            data_zatrudnienia: dataZatrudnienia.value
        };
    }

    // Uzyskanie ID po PESELu, potem wysłanie PATCH
    getpersonid(peselValue)
        .then(id => {
            if (!id) {
                throw new Error("Nie znaleziono osoby o podanym PESELu.");
            }
            console.log(updatedData)
            const url = `http://127.0.0.1:8000/persons/${id}/`;
            console.log(url)
            return fetch(url, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedData)
            });
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text); });
            }
            return response.json();
        })
        .then(data => {
            console.log("Zaktualizowano:", data);
            alert("Dane zostały zaktualizowane.");
            getallpersons();
        })
        .catch(error => {
            console.error("Błąd:", error.message);
            alert("Błąd aktualizacji: " + error.message);
        });
}
     function getallpersons(edit = ""){
            res="<table><tr>"
            res+="<th>lp.</th>"
            res+="<th>Imie</th>"
            res+="<th>Nazwisko</th>"
            res+="<th>Stanowisko</th>"
            res+="<th>Pesel</th>"
            res+="<th>Data Urodzenia</th>"
            res+="<th>Data Zatrudnienia</th>"
            res+="<th>Usuń</th>"
            res+="<th>Edytuj</th>"


            res+="</tr>"
            fetch("http://127.0.0.1:8000/persons")
                .then(response=>response.json())
                .then(response=>{
                console.log(response)
                let i=0
                    for (const person of response){
                        res+="<tr>"
                            if(edit!=person["pesel"]){
                            res+="<th>"+(++i)+"</th>"
                            res+="<td>"+person["imie"]+"</td>"
                            res+="<td>"+person["nazwisko"]+"</td>"
                            res+="<td>"+getjob(person["stanowisko"])+"</td>"
                            res+="<td>"+person["pesel"]+"</td>"
                            res+="<td>"+person["data_urodzenia"].substring(0, 10)+"</td>"
                            res+="<td>"+person["data_zatrudnienia"].substring(0, 10)+"</td>"
                            res+="<td><button onclick='deleteperson("+person.pesel+")'>X</button></td>"
                            res+="<td><button onclick='getallpersons("+person.pesel+")'>/</button></td>"
                            }
                            else{
                                res+="<th>"+(++i)+"</th>"
                            res+="<td><input type='text' value='"+person["imie"]+"' id='uname'></td>"
                            res+="<td><input type='text' value='"+person["nazwisko"]+"' id='usurname'></td>"
                            res+="<td><select value='"+person["stanowisko"]+"' id='ujob'>"+stanowisko.innerHTML+"</select></td>"
                            
                            res+="<td>"+person["pesel"]+"</td>"
                            res+="<td><input type='date' value='"+person["data_urodzenia"].substring(0, 10)+"' id='udob'></td>"
                            res+="<td><input type='date' value='"+person["data_zatrudnienia"].substring(0, 10)+"' id='uhired'></td>"

                            res+="<td>-</td>"
                            res+="<td><button onclick='update("+person.pesel+")'>OK</button></td>"
                            }
                        res+="</tr>"
                    }
                    
                    res+="</table>" 
                    
                getallresponse.innerHTML = res
        })
    }
    getallpersons()
    </script>
    </article>
    <nav>
        <button onclick="show('#addperson')">dodaj</button>
        <button onclick="show('#deleteperson')">usuń</button>
        <button onclick="show('#updateperson')">edytuj</button>
        <button onclick="show('#getperson')">wyswietl 1</button>
        <button id="color">change color theme</button>
        <script>
           function getCookie(name) {
                return document.cookie
                .split('; ')
                .find(row => row.startsWith(name + '='))
                ?.split('=')[1];
            }
           if (getCookie("darkmode") === "true") {
        document.body.setAttribute("class", "darkmode");
    }
           function show(name) {
                const divs = document.querySelectorAll("div");
                divs.forEach(div => {
                div.style.display = "none";
            });
            document.querySelector(name).style.display = "block";
            }
            color.onclick=()=>{
                if(document.body.getAttribute("class")=="darkmode"){
                    document.body.setAttribute("class", "") 
                    document.cookie = "darkmode=false"
                }
                else{
                    document.body.setAttribute("class", "darkmode") 
                    document.cookie = "darkmode=true"
                }
                           
            }
        </script>
    </nav>
    <div id="addperson">
    <h1>Add a person</h1>
    <form>
        <label>
            Imie:<input type="text" id="imie" required>
        </label>
        <label>
            Nazwisko: <input type="text" id="nazwisko" required>
        </label>
        <label>
            Pesel: <input type="number" id = "pesel" min="10000000000" max="99999999999" required>
        </label>
        <label>
           Stanowisko: <select id="stanowisko"></select>

        </label>
        <label>
            Data Urodzenia: <input type="date" id="data_urodzenia" required>
        </label>
        <label>
            Data Zatrudnienia: <input type="date" id="data_zatrudnienia" required>
        </label>
        <input type="button" value="dodaj" id="add">
    </form>
    <p id="addresponse"></p>
    <script>
      add.onclick = () => {
         let data = new Date()
         data = data.toISOString().split('T')[0]
    fetch('http://127.0.0.1:8000/persons/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            imie: imie.value,
            nazwisko: nazwisko.value,
            pesel: pesel.value,
            stanowisko: stanowisko.value,
            data_urodzenia: data_urodzenia.value,
            data_zatrudnienia: data_zatrudnienia.value,
            data_utworzenia: data,
            data_modyfikacji: data
        })
    })
    .then(response => {
        console.log(response)
        if (!response.ok) {
            addresponse.innerHTML= "Błąd: nie dodano osoby"
            return response.text();  // Jeśli odpowiedź ma błąd, nie próbujemy jej parsować jako JSON
        }
        response.json();  // Jeśli odpowiedź jest poprawna, parsujemy ją jako JSON
        console.log('Osoba dodana:', response);  // Możesz sprawdzić dane odpowiedzi
        addresponse.innerHTML= "Sukces: dodano osobę"
        return getallpersons();  // Zaktualizowanie listy osób po dodaniu nowej
    })

    .catch(error => {
        console.error('Błąd:', error);  // Obsługa błędów
    });
};

    </script>
    </div>
    <div id="getperson">
    <h1>Get a person</h1>
    <form>
        <label>
            Pesel <input type="text" id="getpesel" required>
        </label>
        <input type="button" value="wyszukaj" id="get1">

    </form>
    <p id="get1response"></p>
    <script>
        get1.onclick=()=>{
            
            a="http://127.0.0.1:8000/persons/pesel/"+getpesel.value
            console.log(a)
                fetch(a)
                .then(response=>response.json())
                .then(response=>{
                    res="<table>"
                console.log(response)
                   if (response!=null){
                        res+="<tr>"
                            for(const key in response){
                                if (response.hasOwnProperty(key)) {
                                res+="<td>"+response[key]+"</td>"
                                }
                            }
                        res+="</tr>"
                    
                    res+="</table>" 
                get1response.innerHTML = res}
                else{
                    get1response.innerHTML = "person not found"
                }

                })
        }
    </script>
    </div>
    <div id="deleteperson">
    <h1>Delete a person</h1>
    <form>
        <label>
            Pesel <input type="text" id="delpesel" required>
        </label>
        <input type="button" value="usuń" id="del">

    </form>
    <p id="delresponse"></p>
    <script>
    del.onclick = () => {
    getpersonid(delpesel.value)
        .then(res => {
            let id = res;  // Zmienna id z odpowiedzi
            console.log(id)
            let a = "http://127.0.0.1:8000/persons/" + id+"/";  // Budowanie URL

            console.log(a);  // Możesz sprawdzić wynik URL w konsoli

            // Wykonaj zapytanie DELETE
            return fetch(a, { method: 'DELETE' });
        })
        .then(() => getallpersons())  // Po usunięciu, zaktualizuj listę osób
        
};
function deleteperson(pesel){
    getpersonid(pesel)
        .then(res => {
            let id = res;  // Zmienna id z odpowiedzi
            console.log(id)
            let a = "http://127.0.0.1:8000/persons/" + id+"/";  // Budowanie URL

            console.log(a);  // Możesz sprawdzić wynik URL w konsoli

            // Wykonaj zapytanie DELETE
            return fetch(a, { method: 'DELETE' });
        })
        .then(() => getallpersons())  // Po usunięciu, zaktualizuj listę osób
        
};


        </script>
    </div>
    <div id="updateperson">
        <h1>Update a person</h1>
    <form>
        <label>
            Imie:<input type="text" id="imieupd">
        </label>
        <label>
            Nazwisko: <input type="text" id="nazwiskoupd">
        </label>
        <label>
            Pesel: <input type="number" id = "peselupd" min="10000000000" max="99999999999" required>
        </label>
        <label>
            Stanowisko: <select id="stanowiskoupd"></select>
        </label>
        <label>
            Data Urodzenia: <input type="date" id="data_urodzeniaupd">
        </label>
        <label>
            Data Zatrudnienia: <input type="date" id="data_zatrudnieniaupd">
        </label>
        <input type="button" value="aktualizuj" id="upd" onclick="update()">
    </form>
    <p id="updresponse"></p>
    <script>
     show("#addperson")
    </script>
    </div>
</body>
</html>